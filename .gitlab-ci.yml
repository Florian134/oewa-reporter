# Ã–WA Reporter - GitLab CI/CD Pipeline
# =====================================
# Triggered by Airtable Automations or GitLab Schedules

stages:
  - run

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

# Cache fÃ¼r schnellere Builds
cache:
  paths:
    - .cache/pip/

# =============================================================================
# DAILY INGESTION - Standard Job (wird bei jedem Trigger ausgefÃ¼hrt)
# =============================================================================
daily_ingest:
  stage: run
  image: python:3.11-slim
  script:
    - echo "ðŸš€ Ã–WA Reporter - Daily Ingestion"
    - pip install --upgrade pip
    - pip install requests python-dotenv openai
    - python ci_scripts/daily_ingest.py
    - echo "âœ… Daily Ingestion completed!"
  rules:
    - if: $JOB_TYPE == "backfill"
      when: never
    - if: $JOB_TYPE == "weekly"
      when: never
    - if: $CI_COMMIT_REF_NAME == "weekly-trigger"
      when: never
    - if: $CI_PIPELINE_SOURCE == "trigger"
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_PIPELINE_SOURCE == "web"

# =============================================================================
# BACKFILL - Historische Daten laden (manuell triggern mit JOB_TYPE=backfill)
# =============================================================================
backfill:
  stage: run
  image: python:3.11-slim
  script:
    - echo "ðŸ”„ Ã–WA Reporter - Backfill"
    - pip install --upgrade pip
    - pip install requests python-dotenv
    - python ci_scripts/backfill.py --days ${BACKFILL_DAYS:-30}
    - echo "âœ… Backfill completed!"
  rules:
    - if: $JOB_TYPE == "backfill"

# =============================================================================
# WEEKLY REPORT - WÃ¶chentlicher Bericht mit Diagrammen
# Triggern mit: JOB_TYPE=weekly ODER Branch "weekly-trigger"
# =============================================================================
weekly_report:
  stage: run
  image: python:3.11-slim
  script:
    - echo "ðŸ“Š Ã–WA Reporter - Weekly Report"
    - pip install --upgrade pip
    # FÃ¼r Diagramme: plotly, kaleido, pandas
    - pip install requests python-dotenv openai plotly kaleido pandas
    - python ci_scripts/weekly_report.py
    - echo "âœ… Weekly Report completed!"
  rules:
    - if: $JOB_TYPE == "weekly"
    - if: $CI_COMMIT_REF_NAME == "weekly-trigger" && $CI_PIPELINE_SOURCE == "trigger"

# =============================================================================
# ALERT CHECK - TÃ¤gliche Schwellenwert-PrÃ¼fung mit GPT-Analyse
# Triggern mit JOB_TYPE=alert_check
# =============================================================================
alert_check:
  stage: run
  image: python:3.11-slim
  script:
    - echo "ðŸš¨ Ã–WA Reporter - Alert Check"
    - pip install --upgrade pip
    - pip install requests python-dotenv openai
    - python ci_scripts/alert_check.py
    - echo "âœ… Alert Check completed!"
  rules:
    - if: $JOB_TYPE == "alert_check"

# =============================================================================
# NOTIFICATION TEST - Testet alle Teams + GPT Funktionen
# Triggern mit JOB_TYPE=test_notifications
# =============================================================================
test_notifications:
  stage: run
  image: python:3.11-slim
  script:
    - echo "ðŸ§ª Ã–WA Reporter - Notification Tests"
    - pip install --upgrade pip
    - pip install requests
    - python ci_scripts/test_all_notifications.py --all
    - echo "âœ… Notification Tests completed!"
  rules:
    - if: $JOB_TYPE == "test_notifications"
