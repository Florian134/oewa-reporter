# Ã–WA Reporter - GitLab CI/CD Pipeline v2.0
# ==========================================
# Triggered by Airtable Automations or GitLab Schedules
#
# Jobs:
# - daily_ingest: TÃ¤glicher Daten-Import + Wochentags-Alerting
# - backfill: Historische Daten nachladen
# - weekly_report: WÃ¶chentlicher Bericht (jeden Montag)
# - monthly_report: Monatsbericht (am 1. jeden Monats)
# - alert_check: Manueller Alert-Check
# - test_notifications: Test aller Benachrichtigungen

stages:
  - run

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

# Cache fÃ¼r schnellere Builds
cache:
  paths:
    - .cache/pip/

# =============================================================================
# DAILY INGESTION v2.0 - Web + App, alle Metriken, integriertes Alerting
# Wird bei jedem Standard-Trigger ausgefÃ¼hrt (auÃŸer bei spezifischen Job-Types)
# =============================================================================
daily_ingest:
  stage: run
  image: python:3.11-slim
  script:
    - echo "ðŸš€ Ã–WA Reporter - Daily Ingestion v2.0"
    - echo "   Web + App | PI + Visits + UC + HP-PI"
    - pip install --upgrade pip
    - pip install requests python-dotenv openai
    - python ci_scripts/daily_ingest.py
    - echo "âœ… Daily Ingestion completed!"
  rules:
    - if: $JOB_TYPE == "backfill"
      when: never
    - if: $JOB_TYPE == "weekly"
      when: never
    - if: $JOB_TYPE == "monthly"
      when: never
    - if: $JOB_TYPE == "alert_check"
      when: never
    - if: $JOB_TYPE == "test_notifications"
      when: never
    - if: $CI_COMMIT_REF_NAME == "weekly-trigger"
      when: never
    - if: $CI_PIPELINE_SOURCE == "trigger"
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_PIPELINE_SOURCE == "web"

# =============================================================================
# BACKFILL v2.0 - Historische Daten laden (Web + App)
# Triggern mit: JOB_TYPE=backfill BACKFILL_DAYS=30
# =============================================================================
backfill:
  stage: run
  image: python:3.11-slim
  script:
    - echo "ðŸ”„ Ã–WA Reporter - Backfill v2.0"
    - echo "   Lade letzte ${BACKFILL_DAYS:-30} Tage"
    - pip install --upgrade pip
    - pip install requests python-dotenv
    - python ci_scripts/backfill.py --days ${BACKFILL_DAYS:-30}
    - echo "âœ… Backfill completed!"
  rules:
    - if: $JOB_TYPE == "backfill"

# =============================================================================
# WEEKLY REPORT v2.0 - WÃ¶chentlicher Bericht mit groÃŸen Diagrammen
# Triggern mit: JOB_TYPE=weekly
# Automatisch: Jeden Montag via Airtable Automation
# =============================================================================
weekly_report:
  stage: run
  image: python:3.11-slim
  script:
    - echo "ðŸ“Š Ã–WA Reporter - Weekly Report v2.0"
    - pip install --upgrade pip
    - pip install requests python-dotenv openai plotly "kaleido==0.2.1" pandas
    - python ci_scripts/weekly_report.py
    - echo "âœ… Weekly Report completed!"
  rules:
    - if: $JOB_TYPE == "weekly"
    - if: $CI_COMMIT_REF_NAME == "weekly-trigger" && $CI_PIPELINE_SOURCE == "trigger"

# =============================================================================
# MONTHLY REPORT v1.0 - Monatsbericht mit MoM-Vergleich
# Triggern mit: JOB_TYPE=monthly
# Automatisch: Am 1. jeden Monats via Airtable Automation
# Optional: REPORT_MONTH=2025-11 fÃ¼r spezifischen Monat
# =============================================================================
monthly_report:
  stage: run
  image: python:3.11-slim
  script:
    - echo "ðŸ“Š Ã–WA Reporter - Monthly Report v1.0"
    - pip install --upgrade pip
    - pip install requests python-dotenv openai plotly "kaleido==0.2.1" pandas
    - |
      if [ -n "$REPORT_MONTH" ]; then
        echo "   Bericht fÃ¼r: $REPORT_MONTH"
        python ci_scripts/monthly_report.py --month $REPORT_MONTH
      else
        echo "   Bericht fÃ¼r Vormonat"
        python ci_scripts/monthly_report.py
      fi
    - echo "âœ… Monthly Report completed!"
  rules:
    - if: $JOB_TYPE == "monthly"

# =============================================================================
# ALERT CHECK - Manueller Alert-Check (Alerting ist jetzt in daily_ingest integriert)
# Triggern mit: JOB_TYPE=alert_check
# Optional: CHECK_DATE=2025-12-01 fÃ¼r spezifisches Datum
# =============================================================================
alert_check:
  stage: run
  image: python:3.11-slim
  script:
    - echo "ðŸš¨ Ã–WA Reporter - Alert Check"
    - pip install --upgrade pip
    - pip install requests python-dotenv openai
    - |
      if [ -n "$CHECK_DATE" ]; then
        python ci_scripts/alert_check.py --date $CHECK_DATE
      else
        python ci_scripts/alert_check.py
      fi
    - echo "âœ… Alert Check completed!"
  rules:
    - if: $JOB_TYPE == "alert_check"

# =============================================================================
# NOTIFICATION TEST - Testet alle Teams + GPT Funktionen
# Triggern mit: JOB_TYPE=test_notifications
# =============================================================================
test_notifications:
  stage: run
  image: python:3.11-slim
  script:
    - echo "ðŸ§ª Ã–WA Reporter - Notification Tests"
    - pip install --upgrade pip
    - pip install requests
    - python ci_scripts/test_all_notifications.py --all
    - echo "âœ… Notification Tests completed!"
  rules:
    - if: $JOB_TYPE == "test_notifications"
