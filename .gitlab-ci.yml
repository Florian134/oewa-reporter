# Ã–WA Reporter - GitLab CI/CD Pipeline
# =====================================
# Triggered by Airtable Automations

stages:
  - ingest
  - report

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  # Environment Variables werden in GitLab CI/CD Settings definiert

# Cache fÃ¼r schnellere Builds
cache:
  paths:
    - .cache/pip/
    - venv/

# =============================================================================
# DAILY INGESTION - TÃ¤glich um 08:00 UTC (getriggert von Airtable)
# =============================================================================
daily_ingest:
  stage: ingest
  image: python:3.11-slim
  before_script:
    - python -m venv venv
    - source venv/bin/activate
    - pip install --upgrade pip
    - pip install requests python-dotenv openai
  script:
    - echo "ðŸš€ Starting Daily Ingestion..."
    - python scripts/daily_ingest.py
    - echo "âœ… Daily Ingestion completed!"
  rules:
    - if: $TRIGGER_TYPE == "daily"
    - if: $CI_PIPELINE_SOURCE == "trigger" && $TRIGGER_TYPE == "daily"

# =============================================================================
# WEEKLY REPORT - Montag 09:00 UTC (getriggert von Airtable)
# =============================================================================
weekly_report:
  stage: report
  image: python:3.11-slim
  before_script:
    - python -m venv venv
    - source venv/bin/activate
    - pip install --upgrade pip
    - pip install requests python-dotenv openai
  script:
    - echo "ðŸ“Š Generating Weekly Report..."
    - python scripts/weekly_report.py
    - echo "âœ… Weekly Report sent!"
  rules:
    - if: $TRIGGER_TYPE == "weekly"
    - if: $CI_PIPELINE_SOURCE == "trigger" && $TRIGGER_TYPE == "weekly"

# =============================================================================
# MONTHLY REPORT - 1. des Monats 10:00 UTC (getriggert von Airtable)
# =============================================================================
monthly_report:
  stage: report
  image: python:3.11-slim
  before_script:
    - python -m venv venv
    - source venv/bin/activate
    - pip install --upgrade pip
    - pip install requests python-dotenv openai
  script:
    - echo "ðŸ“ˆ Generating Monthly Report..."
    - python scripts/monthly_report.py
    - echo "âœ… Monthly Report sent!"
  rules:
    - if: $TRIGGER_TYPE == "monthly"
    - if: $CI_PIPELINE_SOURCE == "trigger" && $TRIGGER_TYPE == "monthly"

# =============================================================================
# TEST JOB - FÃ¼r manuelle Tests
# =============================================================================
test_pipeline:
  stage: ingest
  image: python:3.11-slim
  script:
    - echo "ðŸ§ª Test Pipeline triggered successfully!"
    - echo "TRIGGER_TYPE = $TRIGGER_TYPE"
    - python --version
  rules:
    - if: $TRIGGER_TYPE == "test"
    - if: $CI_PIPELINE_SOURCE == "trigger" && $TRIGGER_TYPE == "test"
