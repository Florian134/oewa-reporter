# Ã–WA Reporter - GitLab CI/CD Pipeline v2.0
# ==========================================
# Triggered by Airtable Automations or GitLab Schedules
#
# Jobs:
# - daily_ingest: TÃ¤glicher Daten-Import + Wochentags-Alerting
# - backfill: Historische Daten nachladen
# - weekly_report: WÃ¶chentlicher Bericht (jeden Montag)
# - monthly_report: Monatsbericht (am 1. jeden Monats)
# - alert_check: Manueller Alert-Check
# - test_notifications: Test aller Benachrichtigungen

stages:
  - test
  - run
  - deploy

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

# Cache fÃ¼r schnellere Builds
cache:
  paths:
    - .cache/pip/

# =============================================================================
# TEST SUITE - Automatische Tests bei jedem Push
# =============================================================================
test_security:
  stage: test
  image: python:3.11-slim
  script:
    - echo "ðŸ”’ Security Tests"
    - pip install --upgrade pip
    - pip install pytest requests
    - python -m pytest tests/test_security.py -v --tb=short
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  allow_failure: false

test_data_integrity:
  stage: test
  image: python:3.11-slim
  script:
    - echo "ðŸ” Data Integrity Tests"
    - pip install --upgrade pip
    - pip install pytest requests
    - python -m pytest tests/test_data_integrity.py -v --tb=short -m "critical"
  rules:
    - if: $JOB_TYPE == "test_data"
    - if: $CI_PIPELINE_SOURCE == "schedule" && $TEST_TYPE == "data"
  allow_failure: true

test_full_suite:
  stage: test
  image: python:3.11-slim
  script:
    - echo "ðŸ§ª Full Test Suite"
    - pip install --upgrade pip
    - pip install pytest requests
    - python ci_scripts/run_tests.py all
  rules:
    - if: $JOB_TYPE == "test_all"
    - if: $CI_PIPELINE_SOURCE == "schedule" && $TEST_TYPE == "all"
  artifacts:
    when: always
    reports:
      junit: test-results.xml
  allow_failure: true

# =============================================================================
# DAILY INGESTION v2.0 - Web + App, alle Metriken, integriertes Alerting
# Wird bei jedem Standard-Trigger ausgefÃ¼hrt (auÃŸer bei spezifischen Job-Types)
# =============================================================================
daily_ingest:
  stage: run
  image: python:3.11-slim
  script:
    - echo "ðŸš€ Ã–WA Reporter - Daily Ingestion v2.0"
    - echo "   Web + App | PI + Visits + UC + HP-PI"
    - pip install --upgrade pip
    - pip install requests python-dotenv openai
    - python ci_scripts/daily_ingest.py
    - echo "âœ… Daily Ingestion completed!"
  rules:
    - if: $JOB_TYPE == "backfill"
      when: never
    - if: $JOB_TYPE == "unified_backfill"
      when: never
    - if: $JOB_TYPE == "weekly"
      when: never
    - if: $JOB_TYPE == "monthly"
      when: never
    - if: $JOB_TYPE == "alert_check"
      when: never
    - if: $JOB_TYPE == "test_notifications"
      when: never
    - if: $CI_COMMIT_REF_NAME == "weekly-trigger"
      when: never
    - if: $CI_COMMIT_REF_NAME == "monthly-trigger"
      when: never
    - if: $CI_COMMIT_REF_NAME == "backfill-90days"
      when: never
    - if: $CI_COMMIT_REF_NAME == "unified-backfill"
      when: never
    - if: $CI_COMMIT_REF_NAME == "monthly-backfill"
      when: never
    - if: $CI_PIPELINE_SOURCE == "trigger"
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_PIPELINE_SOURCE == "web"

# =============================================================================
# BACKFILL v2.0 - Historische Daten laden (Web + App)
# Triggern mit: JOB_TYPE=backfill ODER Branch "backfill-90days"
# =============================================================================
backfill:
  stage: run
  image: python:3.11-slim
  script:
    - echo "ðŸ”„ Ã–WA Reporter - Backfill v2.0"
    - pip install --upgrade pip
    - pip install requests python-dotenv
    - |
      if [ "$CI_COMMIT_REF_NAME" = "backfill-90days" ]; then
        echo "   Lade letzte 90 Tage (Branch-Trigger)"
        python ci_scripts/backfill.py --days 90
      else
        echo "   Lade letzte ${BACKFILL_DAYS:-30} Tage"
        python ci_scripts/backfill.py --days ${BACKFILL_DAYS:-30}
      fi
    - echo "âœ… Backfill completed!"
  rules:
    - if: $JOB_TYPE == "backfill"
    - if: $CI_COMMIT_REF_NAME == "backfill-90days" && $CI_PIPELINE_SOURCE == "trigger"

# =============================================================================
# WEEKLY REPORT v3.0 - WÃ¶chentlicher Bericht mit Charts
# Triggern mit: JOB_TYPE=weekly ODER Branch "weekly-trigger"
# Automatisch: Jeden Montag via Airtable Automation
# Charts werden in public/charts/ gespeichert fÃ¼r GitLab Pages
# =============================================================================
weekly_report:
  stage: run
  image: python:3.11-slim
  before_script:
    # Git fÃ¼r Chart-Push installieren
    - apt-get update && apt-get install -y git
    - git config --global user.email "ci@oewa-reporter.gitlab.io"
    - git config --global user.name "Ã–WA Reporter CI"
  script:
    - echo "ðŸ“Š Ã–WA Reporter - Weekly Report v3.0"
    - pip install --upgrade pip
    - pip install requests python-dotenv openai plotly "kaleido==0.2.1" pandas
    - python ci_scripts/weekly_report.py
    - echo "âœ… Weekly Report completed!"
    # Charts fÃ¼r Pages anzeigen
    - |
      if [ -d "public/charts" ] && [ "$(ls -A public/charts 2>/dev/null)" ]; then
        echo "ðŸ“Š Charts erstellt:"
        ls -la public/charts/
      fi
  artifacts:
    paths:
      - public/
    expire_in: 1 week
  rules:
    - if: $JOB_TYPE == "weekly"
    - if: $CI_COMMIT_REF_NAME == "weekly-trigger" && $CI_PIPELINE_SOURCE == "trigger"

# =============================================================================
# MONTHLY REPORT v1.0 - Monatsbericht mit MoM-Vergleich
# Triggern mit: JOB_TYPE=monthly ODER Branch "monthly-trigger"
# Automatisch: Am 1. jeden Monats via Airtable Automation
# Optional: REPORT_MONTH=2025-11 fÃ¼r spezifischen Monat
# =============================================================================
monthly_report:
  stage: run
  image: python:3.11-slim
  script:
    - echo "ðŸ“Š Ã–WA Reporter - Monthly Report v1.0"
    - pip install --upgrade pip
    - pip install requests python-dotenv openai plotly "kaleido==0.2.1" pandas
    - |
      if [ -n "$REPORT_MONTH" ]; then
        echo "   Bericht fÃ¼r: $REPORT_MONTH"
        python ci_scripts/monthly_report.py --month $REPORT_MONTH
      else
        echo "   Bericht fÃ¼r Vormonat"
        python ci_scripts/monthly_report.py
      fi
    - echo "âœ… Monthly Report completed!"
  rules:
    - if: $JOB_TYPE == "monthly"
    - if: $CI_COMMIT_REF_NAME == "monthly-trigger" && $CI_PIPELINE_SOURCE == "trigger"

# =============================================================================
# ALERT CHECK - Manueller Alert-Check (Alerting ist jetzt in daily_ingest integriert)
# Triggern mit: JOB_TYPE=alert_check
# Optional: CHECK_DATE=2025-12-01 fÃ¼r spezifisches Datum
# =============================================================================
alert_check:
  stage: run
  image: python:3.11-slim
  script:
    - echo "ðŸš¨ Ã–WA Reporter - Alert Check"
    - pip install --upgrade pip
    - pip install requests python-dotenv openai
    - |
      if [ -n "$CHECK_DATE" ]; then
        python ci_scripts/alert_check.py --date $CHECK_DATE
      else
        python ci_scripts/alert_check.py
      fi
    - echo "âœ… Alert Check completed!"
  rules:
    - if: $JOB_TYPE == "alert_check"

# =============================================================================
# MONTHLY BACKFILL v1.0 - Historische Monatsdaten (unbegrenzt)
# Triggern mit: JOB_TYPE=monthly_backfill ODER Branch "monthly-backfill"
# Optional: START_MONTH=2024-01 (default: 2024-01)
# =============================================================================
monthly_backfill:
  stage: run
  image: python:3.11-slim
  script:
    - echo "ðŸ“… Ã–WA Reporter - Monthly Backfill v1.0"
    - echo "   Historische Monatsdaten (unbegrenzt verfÃ¼gbar)"
    - pip install --upgrade pip
    - pip install requests python-dotenv
    - python ci_scripts/monthly_backfill.py --start ${START_MONTH:-2024-01}
    - echo "âœ… Monthly Backfill completed!"
  rules:
    - if: $JOB_TYPE == "monthly_backfill"
    - if: $CI_COMMIT_REF_NAME == "monthly-backfill"

# =============================================================================
# UNIFIED BACKFILL v3.0 - Ganzheitlicher Backfill mit korrekter UC-Behandlung
# Triggern mit: JOB_TYPE=unified_backfill ODER Branch "unified-backfill"
# Optional: BACKFILL_DAYS=90 (default: 90)
# =============================================================================
unified_backfill:
  stage: run
  image: python:3.11-slim
  script:
    - echo "ðŸ”„ Ã–WA Reporter - Unified Backfill v3.0"
    - echo "   Ganzheitlicher Import mit korrekter UC-Behandlung"
    - pip install --upgrade pip
    - pip install requests python-dotenv
    - python ci_scripts/unified_backfill.py --days ${BACKFILL_DAYS:-400}
    - echo "âœ… Unified Backfill completed!"
  rules:
    - if: $JOB_TYPE == "unified_backfill"
    - if: $CI_COMMIT_REF_NAME == "unified-backfill"

# =============================================================================
# NOTIFICATION TEST - Testet alle Teams + GPT Funktionen
# Triggern mit: JOB_TYPE=test_notifications
# =============================================================================
test_notifications:
  stage: run
  image: python:3.11-slim
  script:
    - echo "ðŸ§ª Ã–WA Reporter - Notification Tests"
    - pip install --upgrade pip
    - pip install requests
    - python ci_scripts/test_all_notifications.py --all
    - echo "âœ… Notification Tests completed!"
  rules:
    - if: $JOB_TYPE == "test_notifications"

# =============================================================================
# GITLAB PAGES - Hostet Charts fÃ¼r Teams-Reports
# Automatisches Deployment bei Ã„nderungen am public/ Ordner
# URL: https://florian1143.gitlab.io/oewa-reporter/
# =============================================================================
pages:
  stage: deploy
  image: alpine:latest
  script:
    - echo "ðŸ“Š Deploying Charts to GitLab Pages..."
    - ls -la public/ || echo "public/ nicht gefunden"
    - ls -la public/charts/ 2>/dev/null || echo "Keine Charts vorhanden"
  artifacts:
    paths:
      - public
  rules:
    # Nur deployen wenn public/ Ordner existiert und Ã„nderungen hat
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - public/**/*
    # Auch bei weekly/monthly Reports deployen
    - if: $CI_COMMIT_REF_NAME == "weekly-trigger"
    - if: $CI_COMMIT_REF_NAME == "monthly-trigger"
